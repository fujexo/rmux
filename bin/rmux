#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/../rmuxid"

HOST="$1"
PORT="22"
shift

argc="$#"
for (( argn=1; argn<=argc; argn++)); do
    if [[ "${!argn}" == "-p" ]]; then
		PORTINDEX="$((argn + 1))"
		PORT="${!PORTINDEX}"
		break
    fi
    if [[ "${!argn}" == "--port" ]]; then
		PORTINDEX="$((argn + 1))"
		PORT="${!PORTINDEX}"
		break
    fi
done

ssh "$@" "$HOST" "uname -a; who; mkdir -p '.rmux-$RMUXID/'; [ -f '.rmux-$RMUXID/init' ]"
NOTEXISTS=$?
# Exit on ssh argument errors, we can't recover from that
if [ $NOTEXISTS -eq 255 ]; then
	exit 255
fi
rsync -vvv -L -r --force --delete --exclude=/tmux-bin --exclude=/.vim/spell --exclude=.git \
		--exclude=/bash_history --exclude=/my_history --exclude=/tmux-detach-hook \
		--exclude=/tmux-attach-hook --exclude="*.pyc" --rsh="ssh -p$PORT" \
		"$HOME/.rmux-$RMUXID/" "$HOST":".rmux-$RMUXID/" 
PID=$!
if [ $NOTEXISTS -ne 0 ]; then
	echo "Initializing"
	wait $PID
fi
ssh "$@" -t -o SendEnv=LC_ALL,SendEnv=LANG "$HOST" "bash --rcfile \"\$HOME/.rmux-$RMUXID/init\" -i"
