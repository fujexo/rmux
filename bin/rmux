#!/bin/bash

# Connect to remote host and take your tmux.conf and vimrc to the host
#
# Connect:
#    rmux $HOST
# Run tmux:
#    tmux ...
# Run vim:
#    vi ...
# Attach tmux session:
#    tmuc [id] ...
# Attach first session:
#    tmuk

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/../rmuxid"

HOST="$1"
shift

PORT="22"

SHORTOPTS="p:"
LONGOPTS="port:"

ARGS=`getopt -s bash --options $SHORTOPTS --longoptions $LONGOPTS  -- "$@" `

eval set -- "$ARGS"

while true; do
	case "$1" in
		"-p" | "--port")
			shift
			PORT="$1"
			;;
		*)
			break
			;;
	esac
	shift
done

ssh -X -A "$HOST" -p "$PORT" "uname -a; who; mkdir -p '.rmux-$RMUXID/'; [ -f '.rmux-$RMUXID/init' ]"
NOTEXISTS=$?
rsync -L -r --force --delete --exclude=/tmux-bin --exclude=/.vim/spell --exclude=.git \
		--exclude=/bash_history --exclude=/my_history --exclude="*.pyc" \
        --exclude=/tmux-attach-hook --exclude=/tmux-detach-hook \
		"$HOME/.rmux-$RMUXID/" --rsh="ssh -p$PORT" "$HOST":".rmux-$RMUXID/" &
PID=$!
if [ $NOTEXISTS -ne 0 ]; then
	echo "Initializing"
	wait $PID
fi
ssh "$@" -p "$PORT" -t -o SendEnv=LC_ALL,SendEnv=LANG "$HOST" "bash --rcfile \"\$HOME/.rmux-$RMUXID/init\" -i"
